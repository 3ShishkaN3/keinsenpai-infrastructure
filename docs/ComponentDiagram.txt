@startuml
!theme plain
skinparam componentStyle uml2
skinparam linetype ortho
skinparam shadowing false

' Определение компонентов с цветами для улучшенной читаемости
package "Клиенты" <<Client>> #LightBlue {
    [Веб-клиент]
    [Мобильный клиент]
    [Административная панель]
}

package "API слой" <<API>> #LightGreen {
    [API Шлюз]
    [Сервис авторизации]
}

package "Основные сервисы" <<Core Services>> #LightYellow {
    [Сервис пользователей]
    [Сервис администрирования]
    [Сервис курсов]
    [Сервис уроков]
    [Сервис материалов]
    [Сервис тестирования]
    [Сервис прогресса]
    [Сервис платежей]
    [Сервис достижений]
}

package "Вспомогательные сервисы" <<Auxiliary Services>> #LightSalmon {
    [Сервис уведомлений]
    [Сервис аналитики]
    [Сервис поиска]
}

package "Хранилища" <<Storage>> #LightGrey {
    database "База данных пользователей"
    database "База данных курсов"
    database "База данных уроков"
    database "База данных материалов"
    database "База данных тестов"
    database "База данных прогресса"
    database "База данных платежей"
    database "База данных достижений"
    [Файловое хранилище]
    [Видео CDN]
}

package "Инфраструктура" <<Infrastructure>> #Thistle {
    queue "Очередь сообщений"
    database "Redis Cache"
}

' Интерфейсы
interface "REST/gRPC" as API
interface "SQL" as SQL
interface "События" as EVENTS
interface "S3 API" as S3
interface "CDN API" as CDN
interface "Cache API" as CACHE
interface "WebSocket" as WS
interface "OAuth2" as OAUTH

' Связи клиентов (раскрашенные стрелки)
[Веб-клиент] --> API #Brown : HTTPS 
[Мобильный клиент] --> API #Brown : HTTPS
[Административная панель] --> API #Brown : HTTPS

' Связи API Шлюза
API -[dotted] [API Шлюз] #Green
[API Шлюз] --> [Сервис авторизации] #Green : JWT
[Сервис авторизации] --> [Сервис пользователей] #DarkGreen : OAUTH

' Связи основных сервисов с Gateway
[API Шлюз] --> [Сервис пользователей] #Green
[API Шлюз] --> [Сервис администрирования] #Green
[API Шлюз] --> [Сервис курсов] #Green
[API Шлюз] --> [Сервис уроков] #Green
[API Шлюз] --> [Сервис материалов] #Green
[API Шлюз] --> [Сервис тестирования] #Green
[API Шлюз] --> [Сервис прогресса] #Green
[API Шлюз] --> [Сервис платежей] #Green
[API Шлюз] --> [Сервис поиска] #Green
[API Шлюз] --> [Сервис достижений] #Green

' Связи Admin сервиса
[Сервис администрирования] --> [Сервис курсов] #Orange
[Сервис администрирования] --> [Сервис уроков] #Orange
[Сервис администрирования] --> [Сервис материалов] #Orange
[Сервис администрирования] --> [Сервис тестирования] #Orange
[Сервис администрирования] --> [Сервис пользователей] #Orange
[Сервис администрирования] --> [Сервис достижений] #Orange

' Связи с БД
[Сервис пользователей] --> SQL #Purple : SQL
SQL - [База данных пользователей] #Purple
[Сервис курсов] --> SQL #Purple : SQL
SQL - [База данных курсов] #Purple
[Сервис уроков] --> SQL #Purple : SQL
SQL - [База данных уроков] #Purple
[Сервис материалов] --> SQL #Purple : SQL
SQL - [База данных материалов] #Purple
[Сервис тестирования] --> SQL #Purple : SQL
SQL - [База данных тестов] #Purple
[Сервис прогресса] --> SQL #Purple : SQL
SQL - [База данных прогресса] #Purple
[Сервис платежей] --> SQL #Purple : SQL
SQL - [База данных платежей] #Purple
[Сервис достижений] --> SQL #Purple : SQL
SQL - [База данных достижений] #Purple

' Связи с кэшем
[Сервис пользователей] --> CACHE #Red
[Сервис курсов] --> CACHE #Red
[Сервис уроков] --> CACHE #Red
[Сервис материалов] --> CACHE #Red
[Сервис тестирования] --> CACHE #Red
[Сервис достижений] --> CACHE #Red
CACHE - [Redis Cache] #Red

' Связи через очередь сообщений
[Сервис пользователей] --> EVENTS #Brown : UserRegistered, UserUpdated
[Сервис курсов] --> EVENTS #Brown : CourseCompleted
[Сервис прогресса] --> EVENTS #Brown : ProgressUpdated
[Сервис платежей] --> EVENTS #Brown : PaymentProcessed
[Сервис тестирования] --> EVENTS #Brown : TestCompleted
[Сервис уроков] --> EVENTS #Brown : LessonCompleted
EVENTS - [Очередь сообщений] #Brown
[Очередь сообщений] --> [Сервис достижений] #Brown : Обработка событий
[Очередь сообщений] --> [Сервис уведомлений] #Brown
[Очередь сообщений] --> [Сервис аналитики] #Brown

' Связи файлового хранилища
[Сервис материалов] --> S3 #Teal
S3 - [Файловое хранилище] #Teal
[Сервис материалов] --> CDN #Teal
CDN - [Видео CDN] #Teal

' Связи поиска
[Сервис поиска] --> [База данных курсов] #DarkBlue
[Сервис поиска] --> [База данных уроков] #DarkBlue
[Сервис поиска] --> [База данных материалов] #DarkBlue
[Сервис поиска] --> [База данных достижений] #DarkBlue

' Межсервисные связи
[Сервис прогресса] --> [Сервис курсов] #Magenta
[Сервис прогресса] --> [Сервис уроков] #Magenta
[Сервис прогресса] --> [Сервис тестирования] #Magenta
[Сервис прогресса] --> [Сервис пользователей] #Magenta
[Сервис прогресса] --> [Сервис достижений] #Magenta : Проверка условий достижений

[Сервис материалов] --> [Сервис уроков] #Magenta
[Сервис тестирования] --> [Сервис уроков] #Magenta

[Сервис платежей] --> [Сервис пользователей] #DarkRed
[Сервис платежей] --> [Сервис курсов] #DarkRed

[Сервис достижений] --> [Сервис пользователей] #Violet : Обновление XP/Level
[Сервис достижений] --> [Сервис прогресса] #Violet : Получение прогресса
[Сервис достижений] --> [Сервис курсов] #Violet : Проверка курсов
[Сервис достижений] --> [Сервис уроков] #Violet : Проверка уроков

' WebSocket связи
[Сервис тестирования] --> WS #Pink
[Сервис достижений] --> WS #Pink : Уведомления о достижениях
WS - [API Шлюз] #Pink
[Сервис прогресса] --> WS #Pink

@enduml